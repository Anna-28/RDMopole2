<!DOCTYPE html="{{locale}}">
    {{> header}}
    <body>
        {{> navbar}}
        <br>
        <h1 align="center" id="header">{{Pokemon}}</h1>
        <br>
        <div style="width:90%; margin-left:calc(5%);">
            <ul class="nav nav-pills justify-content-center">
                <li class="nav-item"><a class="nav-link active" data-toggle="pill" href="#historical">Historical Lookup</a></li>
                <li class="nav-item"><a class="nav-link" data-toggle="pill" href="#shinystats">Shiny Rates</a></li>
                <li class="nav-item"><a class="nav-link" data-toggle="pill" href="#commday">Community Day</a></li>
            </ul>
            <div class="tab-content">
                <div class="tab-pane active" id="historical">
                    <div class="justify-content-center">
                        <canvas id="canvas"></canvas>
                    </div>
                </div>
                <div class="tab-pane fade" id="shinystats">
                    <br>
                    <p class="text-center">
                        Live Shiny Stats for Pok√©mon Go from the last 24 hours.
                    </p>
                    <table id="table" class="table table-{{style}} table-striped table-bordered table-hover dt-responsive nowrap" style="position: center; width:100%">
                        <thead class="thead-dark">
                            <tr>
                                <th>{{ID}}</th>
                                <th>{{Pokemon}}</th>
                                <th>{{Shiny Rate}}</th>
                                <th>{{Shiny / Total}}</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
                <!-- Start Community Day Tab -->
                <div class="tab-pane fade" id="commday">
                    <h3 class="page-header text-center">Community Day Stats</h3>
                    <div class="card text-center p-1 m-3">
                        <div class="card-header bg-dark text-light"><b>Filters</b></div>
                        <div class="card-body">
                            <div class="row">
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <label class="input-group-text" for="commday-start">Start</label>
                                    </div>
                                    <input id="commday-start" class="flatpickr" placeholder="Select Date & Time.." data-toggle="datetimepicker">
                                    <div class="input-group-prepend">
                                        <label class="input-group-text" for="commday-end">End</label>
                                    </div>
                                    <input id="commday-end" class="flatpickr" placeholder="Select Date & Time.." data-toggle="datetimepicker">
                                    <div class="input-group-prepend">
                                        <label class="input-group-text" for="commday-pokemon">Pokemon</label>
                                    </div>
                                    <select id="commday-pokemon" class="custom-select" onchange="getCommDayStats()">
                                        <option disabled selected>{{stats_filter_select}}</option>
                                        {{#pokemon}}
                                            <option value="{{id}}">{{name}}</option>
                                        {{/pokemon}}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                
                    <div class="card text-center p-1 m-3">
                        <div class="card-header bg-dark text-light"><b>Statistics</b></div>
                        <div class="card-body">
                            <div id="comday-stats" class="container">
                                <div class="row m-2">
                                    <div class="col-md-5">
                                        <div class="row p-2">
                                            <div class="col" style="background: white">
                                                <h4 id="pkmn-title">{{stats_scans}}</h4>
                                                <div class="row p-2">
                                                    <div class="col-lg-6">
                                                        <div class="wrapper"><canvas id="scanChart"></canvas></div>
                                                    </div>
                                                    <div class="col-lg-6 justify-content-right">
                                                        <h5 id="total-seen">0 {{stats_seen}}</h5>
                                                        <h6 id="total-scanned">0 {{stats_scanned}}</h6>
                                                    </div>
                                                </div>
                                                <div class="row p-2">
                                                    <div class="col" style="background: white">
                                                        <span><b>{{stats_100iv}}</b><span id="iv100">0</span></span>
                                                        <span><b>{{stats_90iv}}</b><span id="iv90">0</span></span>
                                                        <span><b>{{stats_0iv}}</b><span id="iv0">0</span></span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row p-2">
                                            <div class="col" style="background: white">
                                                <div class="wrapper"><canvas id="levelChart"></canvas></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-7 p-2" style="background: white">
                                        <div class="wrapper"><canvas id="ivChart"></canvas></div>
                                    </div>
                                </div>
                                <div class="row p-2 m-2">
                                    <div class="col-md-4" style="background: white">
                                        <h3>{{stats_sex}}</h3>
                                        <span><span id="total-male">0</span> {{stats_male_spawns}}</span><br>
                                        <span><span id="total-female">0</span> {{stats_female_spawns}}</span>
                                    </div>
                                    <div class="col-md-8" style="background: white">
                                        <div class="row text-center">
                                            <div class="col-4">
                                                <img id="evo1" src="#" height=72 width=72/><br>
                                                <b id="evo1-text"></b>
                                            </div>
                                            <div class="col-4">
                                                <img id="evo2" src="#" height=72 width=72/><br>
                                                <b id="evo2-text"></b>
                                            </div>
                                            <div class="col-4 justify-content-end">
                                                <img id="evo3" src="#" height=72 width=72/><br>
                                                <b id="evo3-text"></b>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End Community Day Tab -->
            </div>
        </div>
        <br>
    </body>
</html>

<script type='text/javascript'>
    $("#commday-start").flatpickr({
        altInput: true,
        altFormat: "F j, Y h\:00 K",
        dateFormat: "U",//"Y-m-d h K",
        enableTime: true
    });
    $("#commday-end").flatpickr({
        altInput: true,
        altFormat: "F j, Y h\:00 K",
        dateFormat: "U",//"Y-m-d h K",
        enableTime: true
    });

    if ("{{style}}" === 'dark') {
        $('body').css('background-color', 'rgb(33, 37, 41)');
        $('body').css('color', 'rgb(255, 255, 255)');
    }
    const table = $('#table').DataTable({
        "ajax": {
            "url": "/api/pokemon/shiny",
            "dataSrc": "data.pokemon",
            "async": true
        },
        //"dom": "Bfrtip",
        // Reference: https://stackoverflow.com/a/43176143
        /*
        "dom": "<'row'<'col-sm-8'B><'col-sm-4'f>t>" +
                "<'row'<'col-sm-4'li><'col-sm-8'p>>",
        */
        "dom": "<'row'<'col-sm-12 col-md-6'B><'col-sm-12 col-md-6'f>>" +
                "<'row'<'col-sm-12'tr>>" +
                "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>",
        "fixedHeader": {
            "header": true,
            "headerOffset": $('.navbar').height() + 15
        },
        "buttons": [
            "colvis",
            "pageLength"
        ],
        "colReorder": true,
        "stateSave": true,
        "paging":   true,
        "lengthMenu": [[25, 50, 100, -1], [25, 50, 100, "All"]],
        "pageLength": 100,
        "columns": [
            { "data": "id" },
            { "data": "pokemon" },
            { "data": "rate" },
            { "data": "count" },
        ],
        "info": true,
        "order": [[ 0, "asc" ]],
        "search.caseInsensitive": true,
        "responsive": true
    });

    function getCommDayStats() {
        var start = $('#commday-start').val();
        var end = $('#commday-end').val();
        var pokemon = $('#commday-pokemon').val();
        var data = {
            'type': 'commday',
            'pokemon_id': pokemon,
            'start': start,
            'end': end,
            //'_csrf': "{{csrf}}"
        };
        $.ajax({ 
            url: "/api/stats", 
            data: data, 
            type: "POST", 
            success: function(result) {
                if (result === null) {
                    console.log("Failed to parse result value.");
                    return;
                }

                $("#comday-stats").show();
                $("#pkmn-title").text(result.data.evo1_name + " Scans");
                $("#total-seen").text(numberWithCommas(result.data.stats.total || 0) + " seen");
                $("#total-scanned").text(numberWithCommas(result.data.stats.with_iv || 0) + " scanned");
                $("#iv100").text(result.data.stats.iv_100 || 0);
                $("#iv90").text(result.data.stats.iv_90_99 || 0);
                $("#iv0").text(result.data.stats.iv_0 || 0);
                $("#total-male").text(numberWithCommas(result.data.stats.male || 0) + " (" + Math.round((result.data.stats.male / result.data.stats.total) * 100, 2) + "%)");
                $("#total-female").text(numberWithCommas(result.data.stats.female || 0) + " (" + Math.round((result.data.stats.female / result.data.stats.total) * 100, 2) + "%)");
                $("#evo1").attr("src", "./static/img/pokemon/"+result.data.pokemon_id+".png");
                $("#evo2").attr("src", "./static/img/pokemon/"+(parseInt(result.data.pokemon_id) + 1)+".png");
                $("#evo3").attr("src", "./static/img/pokemon/"+(parseInt(result.data.pokemon_id) + 2)+".png");
                $("#evo1-text").text(result.data.evo1_name);
                $("#evo2-text").text(result.data.evo2_name);
                $("#evo3-text").text(result.data.evo3_name);
        
                removeDataset(scanChart);
                var scanData = {
                data: [result.data.stats.total || 0, result.data.stats.with_iv || 0],
                backgroundColor: [
                    'green',
                    'blue'
                ],
                label: 'Seen'
                };
                addDataset(scanChart, scanData);
        
                removeDataset(levelChart);
                var levelData = {
                    data: [
                        result.data.stats.level_1_9 || 0,
                        result.data.stats.level_10_19 || 0,
                        result.data.stats.level_20_29 || 0,
                        result.data.stats.level_30_35 || 0
                    ],
                    backgroundColor: [
                        'red',
                        'yellow',
                        'green',
                        'blue'
                    ],
                    label: 'Levels'
                };
                addDataset(levelChart, levelData);
        
                removeDataset(ivChart);
        
                addDataset(ivChart, { data: [result.data.stats.iv_0], backgroundColor: 'black', label: '0% IV' });
                addDataset(ivChart, { data: [result.data.stats.iv_1_9], backgroundColor: 'brown', label: '1-9% IV' });
                addDataset(ivChart, { data: [result.data.stats.iv_10_19], backgroundColor: 'pink', label: '10-19% IV' });
                addDataset(ivChart, { data: [result.data.stats.iv_20_29], backgroundColor: 'gray', label: '20-29% IV' });
                addDataset(ivChart, { data: [result.data.stats.iv_30_39], backgroundColor: 'purple', label: '30-39% IV' });
                addDataset(ivChart, { data: [result.data.stats.iv_40_49], backgroundColor: 'blue', label: '40-49% IV' });
                addDataset(ivChart, { data: [result.data.stats.iv_50_59], backgroundColor: 'red', label: '50-59% IV' });
                addDataset(ivChart, { data: [result.data.stats.iv_60_69], backgroundColor: 'orange', label: '60-69% IV' });
                addDataset(ivChart, { data: [result.data.stats.iv_70_79], backgroundColor: 'lime', label: '70-79% IV' });
                addDataset(ivChart, { data: [result.data.stats.iv_80_89], backgroundColor: 'yellow', label: '80-89% IV' });
                addDataset(ivChart, { data: [result.data.stats.iv_90_99], backgroundColor: 'magenta', label: '90-99% IV' });
                addDataset(ivChart, { data: [result.data.stats.iv_100], backgroundColor: 'green', label: '100% IV' });
        }});
    }

</script>